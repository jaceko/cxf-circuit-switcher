{
  "name": "Cxf-circuit-switcher",
  "tagline": "Failover feature for Apache CXF webservice client. Contains failback (failover recovery).",
  "body": "### CXF Circuit Switcher\r\nCXF Circuit Switcher is an extension of the Apache CXF webservice client. It provides a failover feature inspired by the [Circuit Breaker design pattern](http://en.wikipedia.org/wiki/Circuit_breaker_design_pattern) and Michael T. Nygard's book _\"Release It\"_. \r\nThe library can be used as a SOAP (JAX-WS) as well REST (JAX-RS) client feature to detect connection errors and redirect client to next available node (failover). After some (defined) time it can attempt to restore connection to a previously discarded node (failback). \r\nAbility to failback is a main functional improvement comparing to standard failover feature being part of Apache CXF package. \r\n\r\n**NOTE: This software is neither endorsed nor created by the Apache Software Foundation**\r\n\r\n### Circuit Switcher\r\nThe webservice client is configured with one or more target endpoints in the order of preference (primary node as the first). The integration to each of remote endpoints is seen a \"cicruit\" which is watched by a Circuit Switcher and and when things are looking bad (the remote webservice is not responding or response time exceeds configurable _**receiveTimeout**_) we back off for some time and try next endpoint (switch to another circuit).\r\n\r\nEach of the circuits can be in 3 states: **Closed**, **Open** and **HalfOpen**\r\n\r\nWhen in **Closed** state, each call to the target endpoint is allowed. But each time it fails, a failure counter is incremented, and when the failure counter reaches a configurable _**failureThreshold**_, the circuit moves to the **Open** state.\r\n\r\nWhen it moves to **Open** state, it starts a timer set to elapse at a configurable _**resetTimeout**_ value. If the timeout has not been reached, each call to the target endpoint is not allowed and next endpoint from the _**addressList**_ is selected or exception is thrown if no more endpoints available.\r\n\r\nWhen the _resetTimeout_ has been reached, the circuit moves to **HalfOpen** state. In this state we are tentatively calling the target endpoint to check if it's healthy again. This means that the next call to the endpoint is allowed, but if it fails, the circuit immediately switches back to the **Open** state and the timeout period starts again. If the call to the target endpoint while in **HalfOpen** state succeeds, the circuit switches back to the **Closed** state.\r\n\r\n### Integration with Apache CXF\r\nThe CXF Circuit Switcher is exposed as Apache CXF's [feature](http://cxf.apache.org/docs/features.html) which is a standard way of adding capabilities to an Apache CXF based client. \r\nAll we need to do is instantiate the _CircuitSwitcherClusteringFeature_ class setting addressList, resetTimeout, failureThreshold and receiveTimeout. Next step would be to pass it to a standard Apache CXF org.apache.cxf.jaxws.JaxWsProxyFactoryBean (SOAP) or org.apache.cxf.jaxrs.client.JAXRSClientFactoryBean and create webservice client.\r\n\r\n*Examples:*\r\n\r\nSpring:\r\n```\r\n<bean id=\"clientFactory\" class=\"org.apache.cxf.jaxws.JaxWsProxyFactoryBean\">\r\n\t<property name=\"serviceClass\"\r\n\t\tvalue=\"com.github.jaceko.SomeServiceInterface\" />\r\n\t<property name=\"features\">\r\n\t\t<util:list>\r\n\t\t\t<bean class=\"org.apache.cxf.clustering.CircuitSwitcherClusteringFeature\">\r\n\t\t\t\t<property name=\"addressList\">\r\n\t\t\t\t\t<list>\r\n\t\t\t\t\t\t<value>http://serverA/endpoint</value>\r\n\t\t\t\t\t\t<value>http://serverB/endpoint</value>\r\n\t\t\t\t\t\t<value>http://serverC/endpoint</value>\r\n\t\t\t\t\t</list>\r\n\t\t\t\t</property>\r\n\t\t\t\t<property name=\"resetTimeout\" value=\"10000\" />\r\n\t\t\t\t<property name=\"failureThreshold\" value=\"3\" />\r\n\t\t\t\t<property name=\"receiveTimeout\" value=\"600000\" />\r\n\t\t\t</bean>\r\n\t\t</util:list>\r\n\t</property>\r\n</bean>\r\n<bean id=\"clientTarget\" factory-bean=\"clientFactory\"\r\n\tfactory-method=\"create\" scope=\"prototype\" lazy-init=\"true\" />\r\n```\r\nCode:\r\n\r\n```\r\nJaxWsProxyFactoryBean bean = new JaxWsProxyFactoryBean();\r\nbean.setServiceClass(SomeServiceInterface.class);\r\nCircuitSwitcherClusteringFeature cbcFeature = new CircuitSwitcherClusteringFeature();\r\nList<String> addresses =new ArrayList<String>();\r\nadresses.add(\"http://serverA/endpoint\");\r\nadresses.add(\"http://serverB/endpoint\");\r\nadresses.add(\"http://serverC/endpoint\");\r\ncbcFeature.setAddressList(adresses);\r\ncbcFeature.setFailureThreshold(3);\r\ncbcFeature.setResetTimeout(10000);\r\ncbcFeature.setReceiveTimeout(600000l);\r\nSomeServiceInterface serviceClient = bean.create(SomeServiceInterface.class);\r\n```\r\n### Thread safety\r\nCircuitSwitcherClusteringFeature is an extension of a standard Apache's FailoverFeature and as stated by CXF's javadoc this makes the client **not thread safe**. \r\nOne of solutions is one I found this [blog post](http://nurkiewicz.blogspot.co.uk/2011/05/enabling-load-balancing-and-failover-in.html). Basically the idea is to use Spring and wrap the client bean (must be of _prototype_ scope) in a special proxy. Spring will then create an object pool (based on [commons-pool](http://commons.apache.org/pool) library) and create as many bean instances as necessary to keep each bean used by only one thread.\r\n```\r\n<bean id=\"client\" class=\"org.springframework.aop.framework.ProxyFactoryBean\">\r\n        <property name=\"targetSource\">\r\n            <bean class=\"org.springframework.aop.target.CommonsPoolTargetSource\">\r\n                <property name=\"targetClass\"\r\n                    value=\"com.github.jaceko.SomeServiceInterface\" />\r\n                <property name=\"targetBeanName\" value=\"clientTarget\" />\r\n                <property name=\"maxSize\" value=\"20\" />\r\n                <property name=\"maxWait\" value=\"5000\" />\r\n            </bean>\r\n        </property>\r\n</bean>\r\n```\r\nThe above snippet means that we tell Spring not to create more than 20 clients in the pool and if the pool is empty (all the beans are currently in use), we should wait no more than 5000ms.\r\n### Maven\r\nMaven artifact is available in [central](http://search.maven.org/#artifactdetails|com.github.jaceko.cxf|cxf-circuit-switcher|1.0|jar):\r\n\r\n```\r\n<depencency>\r\n\t<groupId>com.github.jaceko.cxf</groupId>\r\n\t<artifactId>cxf-circuit-switcher</artifactId>\r\n\t<version>1.0</version>\r\n</depencency>\r\n```\r\n\r\n### Maturity\r\nThe library has been production tested and has good unit and integration test coverage. \r\nFeel free to report any [issues](https://github.com/jaceko/cxf-circuit-switcher/issues)",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}